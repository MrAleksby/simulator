<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>–°–ø–æ—Ç–æ–≤—ã–π —Å–∏–º—É–ª—è—Ç–æ—Ä</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 0; }
        .container { max-width: 400px; margin: 40px auto; background: #fff; padding: 24px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        h2 { text-align: center; }
        button { margin: 4px 0; width: 100%; padding: 10px; font-size: 16px; border-radius: 4px; border: none; background: #007bff; color: #fff; cursor: pointer; }
        button:disabled { background: #aaa; }
        input { width: 100%; padding: 8px; margin: 4px 0 12px 0; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; }
        .container input {
            width: 100%;
            box-sizing: border-box;
            margin-left: 0;
            margin-right: 0;
        }
        .form-btn {
            width: 100%;
            box-sizing: border-box;
            margin-left: 0;
            margin-right: 0;
        }
        .info { background: #e9ecef; padding: 10px; border-radius: 4px; margin-bottom: 12px; }
        .success { color: green; }
        .error { color: red; }
        .bot-btn {
            background: #28a745;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 8px 18px;
            font-size: 15px;
            font-weight: 500;
            margin: 8px 0 8px 0;
            transition: background 0.2s;
            box-shadow: 0 1px 4px rgba(0,0,0,0.07);
        }
        .bot-btn:hover {
            background: #218838;
        }
        .bot-btn-fixed {
            position: fixed;
            top: 24px;
            right: 32px;
            width: 54px;
            height: 54px;
            background: #28a745;
            color: #fff;
            border: none;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.13);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            cursor: pointer;
            z-index: 2000;
            transition: background 0.2s, box-shadow 0.2s;
        }
        .bot-btn-fixed:hover {
            background: #218838;
            box-shadow: 0 4px 16px rgba(0,0,0,0.18);
        }
        .history-btn-fixed {
            position: fixed;
            top: 90px;
            right: 32px;
            width: 54px;
            height: 54px;
            background: #007bff;
            color: #fff;
            border: none;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.13);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            cursor: pointer;
            z-index: 2000;
            transition: background 0.2s, box-shadow 0.2s;
        }
        .history-btn-fixed:hover {
            background: #0056b3;
            box-shadow: 0 4px 16px rgba(0,0,0,0.18);
        }
        .update-btn-fixed {
            position: fixed;
            top: 24px;
            left: 32px;
            width: 54px;
            height: 54px;
            background: #ffc107;
            color: #222;
            border: none;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.13);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            cursor: pointer;
            z-index: 2000;
            transition: background 0.2s, box-shadow 0.2s;
        }
        .update-btn-fixed:hover {
            background: #e0a800;
            box-shadow: 0 4px 16px rgba(0,0,0,0.18);
        }
        .leaderboard-btn-fixed {
            position: fixed;
            top: 156px;
            right: 32px;
            width: 54px;
            height: 54px;
            background: #ffc107;
            color: #222;
            border: none;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.13);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            cursor: pointer;
            z-index: 2000;
            transition: background 0.2s, box-shadow 0.2s;
        }
        .leaderboard-btn-fixed:hover {
            background: #e0a800;
            box-shadow: 0 4px 16px rgba(0,0,0,0.18);
        }
        @media (max-width: 600px) {
            .container {
                max-width: 100vw;
                min-width: 100vw;
                margin: 0;
                padding: 8px 0 16px 0;
                border-radius: 0;
                box-shadow: none;
            }
            #authSection {
                max-width: 100vw !important;
                min-width: 100vw !important;
                margin: 0 !important;
                padding: 12px 0 18px 0 !important;
                border-radius: 0 !important;
                box-shadow: none !important;
            }
            .info {
                font-size: 15px;
                padding: 6px;
            }
            button, .form-btn {
                font-size: 15px;
                padding: 8px;
            }
            input, select {
                font-size: 15px;
                padding: 8px;
            }
            .bot-btn-fixed,
            .history-btn-fixed,
            .update-btn-fixed,
            .leaderboard-btn-fixed {
                position: fixed;
                right: 16px;
                left: unset;
                width: 48px;
                height: 48px;
                font-size: 20px;
                z-index: 3000;
                margin: 0;
                box-shadow: 0 2px 8px rgba(0,0,0,0.13);
            }
            .bot-btn-fixed { bottom: 128px; top: unset; }
            .history-btn-fixed { bottom: 72px; top: unset; }
            .leaderboard-btn-fixed { bottom: 16px; top: unset; }
            #leaderboard-modal > div,
            #historyModal > div {
                min-width: 100vw !important;
                max-width: 100vw !important;
                border-radius: 0 !important;
                padding: 12px 0 !important;
                margin: 0 !important;
            }
            table, th, td {
                font-size: 14px !important;
                word-break: break-word;
            }
        }
    </style>
    <!-- Firebase App (core) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <!-- Firebase Auth -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <!-- Firebase Firestore (–±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
<!-- –§–æ—Ä–º–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ -->
<div id="authSection" style="max-width:400px;margin:40px auto 0 auto;background:#fff;padding:24px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
  <h2>–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
  <input type="text" id="authUsername" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" style="width:100%;padding:8px;margin-bottom:8px;">
  <input type="email" id="authEmail" placeholder="Email" style="width:100%;padding:8px;margin-bottom:8px;">
  <input type="password" id="authPassword" placeholder="–ü–∞—Ä–æ–ª—å" style="width:100%;padding:8px;margin-bottom:8px;">
  <button onclick="loginUser()" style="width:100%;margin-bottom:8px;">–í–æ–π—Ç–∏</button>
  <button onclick="registerUser()" style="width:100%;background:#28a745;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
  <button onclick="sendPasswordReset()" style="width:100%;background:#ffc107;color:#222;margin-top:8px;">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</button>
  <div id="authMsg" style="margin-top:8px;color:red;"></div>
</div>
<!-- –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞ -->
<button id="logoutBtn" onclick="logoutUser()" style="display:none;position:fixed;right:32px;bottom:32px;width:54px;height:54px;background:#dc3545;color:#fff;border:none;border-radius:50%;box-shadow:0 2px 8px rgba(0,0,0,0.13);font-size:22px;z-index:2000;cursor:pointer;transition:background 0.2s, box-shadow 0.2s;">
  ‚éã
</button>
<div class="container" id="simSection" style="display:none;">
    <img src="logo.jpg" alt="–õ–æ–≥–æ—Ç–∏–ø" style="display:block;margin:12px auto 24px auto;width:84px;height:84px;object-fit:cover;border-radius:50%;box-shadow:0 2px 8px rgba(0,0,0,0.10);background:#fff;">
    <div class="info">
        <div>–ë–∞–ª–∞–Ω—Å: <span id="balance">10000</span> $</div>
        <div>–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ BTC: <span id="price">-</span> $</div>
        <div>–ü–æ–∑–∏—Ü–∏—è: <span id="position">–Ω–µ—Ç</span></div>
        <div>–¢–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç: <span id="take">-</span></div>
        <div>–°—Ç–æ–ø-–ª–æ—Å—Å: <span id="stop">-</span></div>
    </div>
    <button id="historyBtn" onclick="showHistory()" class="history-btn-fixed" title="–ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Å–¥–µ–ª–æ–∫">
        <span style="font-size:22px;">üìä</span>
    </button>
    <button id="leaderboardBtn" onclick="openLeaderboard()" class="leaderboard-btn-fixed" title="–¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤">
        <span style="font-size:22px;">üèÜ</span>
    </button>
    <input type="number" id="amountInput" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ BTC" min="1" value="1" style="width:100%;padding:8px;margin:4px 0 12px 0;">
    <button onclick="buy()" id="buyBtn" class="form-btn">–ö—É–ø–∏—Ç—å</button>
    <button onclick="sell()" id="sellBtn" class="form-btn">–ü—Ä–æ–¥–∞—Ç—å</button>
    <div style="display:flex; gap:8px; align-items:center; margin-bottom:4px;">
      <input type="number" id="takeInput" placeholder="–¢–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç" style="flex:1;">
      <select id="takeType" style="width:60px;">
        <option value="abs">$</option>
        <option value="percent">%</option>
      </select>
    </div>
    <div style="display:flex; gap:8px; margin-bottom:8px;">
      <button onclick="setTake()" class="form-btn" style="flex:1;">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç</button>
      <button onclick="removeTake()" style="background:#dc3545;color:#fff;min-width:44px;max-width:44px;border-radius:4px;">‚úï</button>
    </div>
    <div style="display:flex; gap:8px; align-items:center; margin-bottom:4px;">
      <input type="number" id="stopInput" placeholder="–°—Ç–æ–ø-–ª–æ—Å—Å" style="flex:1;">
      <select id="stopType" style="width:60px;">
        <option value="abs">$</option>
        <option value="percent">%</option>
      </select>
    </div>
    <div style="display:flex; gap:8px; margin-bottom:8px;">
      <button onclick="setStop()" class="form-btn" style="flex:1;">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–æ–ø-–ª–æ—Å—Å</button>
      <button onclick="removeStop()" style="background:#dc3545;color:#fff;min-width:44px;max-width:44px;border-radius:4px;">‚úï</button>
    </div>
    <div id="result" style="margin-top:12px;"></div>
</div>
<div id="historyModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); z-index:1000;">
  <div style="background:#fff; max-width:400px; margin:60px auto; padding:24px; border-radius:8px; position:relative;">
    <h3>–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∑–∏—Ü–∏–π</h3>
    <div id="historyContent" style="max-height:340px; overflow-y:auto;"></div>
    <button onclick="clearHistory()" style="margin-top:8px; background:#dc3545; color:#fff; width:100%;">–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
    <button onclick="closeHistory()" style="margin-top:16px; background:#dc3545;">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>
<script src="leaderboard.js"></script>
<script>
// === Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===
const firebaseConfig = {
  apiKey: "AIzaSyBcimqYLlWGq59eqC8jwGMDCayPCVnpsMM",
  authDomain: "spot-ec802.firebaseapp.com",
  projectId: "spot-ec802",
  storageBucket: "spot-ec802.firebasestorage.app",
  messagingSenderId: "1029240266799",
  appId: "1:1029240266799:web:b26a460288b182068966da",
  measurementId: "G-6R94B7LFZZ"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
// === –∫–æ–Ω–µ—Ü –±–ª–æ–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ ===

let balance = 10000;
let position = null; // {type: 'long'|'short', entry: number, amount: number}
let stopLoss = null;
let takeProfit = null;
let history = [];
let selectedAsset = 'BTC';

// –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
function syncGlobals() {
    window.position = position;
    window.balance = balance;
    window.stopLoss = stopLoss;
    window.takeProfit = takeProfit;
}
syncGlobals();
window.updateUI = updateUI;

// –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∏–∑ localStorage –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
try {
    const saved = localStorage.getItem('futures_history');
    if (saved) history = JSON.parse(saved);
} catch(e) { history = []; }

// –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–∞–ª–∞–Ω—Å –∏ —Ü–µ–Ω—É, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
if (typeof balance !== 'number' || isNaN(balance)) balance = 10000;

// –ü—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç–æ–∂–µ –æ–∫—Ä—É–≥–ª—è–µ–º —Ü–µ–Ω—É

// –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ü–µ–Ω—ã –ø–æ –∞–∫—Ç–∏–≤—É
function formatPrice(value, asset = selectedAsset) {
    if (asset === 'BTC') return Number(value).toFixed(2);
    return Number(value).toFixed(4); // BTC –∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
}

function updateUI(msg = '', msgClass = '') {
    syncGlobals();
    document.getElementById('balance').textContent = balance.toFixed(4);
    document.getElementById('price').parentNode.innerHTML = `–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ BTC: <span id="price">${(typeof price === 'number' && !isNaN(price)) ? formatPrice(price) : '-'}</span> $`;
    document.getElementById('position').textContent = position ? `${formatPrice(position.entry)}${position.amount ? ', ' + Number(position.amount).toFixed(4) + ' BTC' : ''}` : '–Ω–µ—Ç';
    document.getElementById('stop').textContent = stopLoss !== null ? formatPrice(stopLoss) : '-';
    document.getElementById('take').textContent = takeProfit !== null ? formatPrice(takeProfit) : '-';
    document.getElementById('buyBtn').disabled = false;
    document.getElementById('sellBtn').disabled = !position;
    document.getElementById('stopInput').disabled = !position;
    document.getElementById('takeInput').disabled = !position;
    if(msg) {
        document.getElementById('result').innerHTML = `<span class="${msgClass}">${msg}</span>`;
    } else {
        document.getElementById('result').innerHTML = '';
    }
}

function buy() {
    syncGlobals();
    const amount = parseFloat(document.getElementById('amountInput').value) || 1;
    const cost = amount * price;
    if (balance < cost) {
        updateUI('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –ø–æ–∫—É–ø–∫–∏!', 'error');
        return;
    }
    balance -= cost;
    if (!position) {
        const roundedPrice = Number(price.toFixed(4));
        position = {type: 'long', entry: roundedPrice, amount: amount};
        // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –æ –ø–æ–∫—É–ø–∫–µ –≤ –∏—Å—Ç–æ—Ä–∏—é
        const leverage = 1;
        const margin = amount * roundedPrice;
        history.push({
            type: position.type,
            entry: roundedPrice,
            exit: null,
            profit: null,
            leverage: leverage,
            amount: amount,
            margin: margin,
            reason: '–æ—Ç–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–∏',
            asset: selectedAsset
        });
        saveHistory();
    } else {
        // –î–æ–∫—É–ø–∫–∞: —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ä–µ–¥–Ω—é—é —Ü–µ–Ω—É
        const prevAmount = position.amount || 0;
        const prevEntry = position.entry || price;
        const newAmount = prevAmount + amount;
        const avgPrice = ((prevEntry * prevAmount) + (price * amount)) / newAmount;
        const roundedPrice = Number(price.toFixed(4));
        // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –æ –¥–æ–∫—É–ø–∫–µ –≤ –∏—Å—Ç–æ—Ä–∏—é
        const leverage = 1;
        const margin = amount * roundedPrice;
        history.push({
            type: position.type,
            entry: roundedPrice,
            exit: null,
            profit: null,
            leverage: leverage,
            amount: amount,
            margin: margin,
            reason: '–¥–æ–∫—É–ø–∫–∞',
            asset: selectedAsset
        });
        saveHistory();
        position.entry = avgPrice;
        position.amount = newAmount;
    }
    syncGlobals();
    updateUI('–ö—É–ø–ª–µ–Ω–æ ' + amount + ' BTC –ø–æ ' + price.toFixed(4) + ' $', 'success');
    saveAllUserData();
}

function saveHistory() {
    try {
        localStorage.setItem('futures_history', JSON.stringify(history));
    } catch(e) {}
    const user = auth.currentUser;
    if (user) saveUserData(user.uid);
}

function sell() {
    syncGlobals();
    if(!position) return;
    const amount = position.amount;
    const proceeds = Number((amount * price).toFixed(4));
    // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –≤ –∏—Å—Ç–æ—Ä–∏—é
    const leverage = position.leverage || 1;
    const margin = (amount * position.entry) / leverage;
    const profit = Number(((price - position.entry) * amount).toFixed(4));
    history.push({
        type: position.type,
        entry: position.entry,
        exit: price,
        proceeds: proceeds,
        profit: profit,
        leverage: leverage,
        amount: amount,
        margin: margin,
        reason: '—Ä—É—á–Ω–∞—è –ø—Ä–æ–¥–∞–∂–∞',
        asset: selectedAsset
    });
    saveHistory();
    balance += proceeds;
    position = null;
    stopLoss = null;
    takeProfit = null;
    syncGlobals();
    updateUI('–ü—Ä–æ–¥–∞–Ω–æ ' + amount + ' BTC –ø–æ ' + price.toFixed(4) + ' $', 'success');
    saveAllUserData();
}

function setStop() {
    syncGlobals();
    if(!position) return;
    const val = parseFloat(document.getElementById('stopInput').value);
    const type = document.getElementById('stopType').value;
    if(isNaN(val)) {
        updateUI('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Å—Ç–æ–ø-–ª–æ—Å—Å!', 'error');
        return;
    }
    let sl = null;
    if(type === 'abs') {
        sl = val;
    } else {
        // %
        if(position.type === 'long') {
            sl = position.entry * (1 - val/100);
        } else {
            sl = position.entry * (1 + val/100);
        }
    }
    stopLoss = parseFloat(sl.toFixed(4));
    syncGlobals();
    updateUI(`–°—Ç–æ–ø-–ª–æ—Å—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: ${formatPrice(stopLoss)} $`, 'success');
    saveAllUserData();
}

function setTake() {
    syncGlobals();
    if(!position) return;
    const val = parseFloat(document.getElementById('takeInput').value);
    const type = document.getElementById('takeType').value;
    if(isNaN(val)) {
        updateUI('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ç–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç!', 'error');
        return;
    }
    let tp = null;
    if(type === 'abs') {
        tp = val;
    } else {
        // %
        if(position.type === 'long') {
            tp = position.entry * (1 + val/100);
        } else {
            tp = position.entry * (1 - val/100);
        }
    }
    // –ü—Ä–æ–≤–µ—Ä–∫–∞: —Ç–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∏–∂–µ —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω—ã –≤—Ö–æ–¥–∞
    if (tp < position.entry) {
        updateUI('–¢–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∏–∂–µ —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω—ã –≤—Ö–æ–¥–∞!', 'error');
        return;
    }
    takeProfit = parseFloat(tp.toFixed(4));
    syncGlobals();
    updateUI(`–¢–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: ${formatPrice(takeProfit)} $`, 'success');
    saveAllUserData();
}

function closePosition(profit, reason) {
    const leverage = position.leverage || 1;
    const amount = position.amount || 1;
    const pnl = profit * amount;
    const margin = (amount * position.entry) / leverage;
    const exitPrice = reason === '—Å—Ç–æ–ø-–ª–æ—Å—Å' ? (position.type === 'long' ? stopLoss : stopLoss) : (position.type === 'long' ? takeProfit : takeProfit);
    const exit = exitPrice !== undefined && exitPrice !== null ? exitPrice : price;
    history.push({
        type: position.type,
        entry: position.entry,
        exit: exit,
        profit: pnl,
        leverage: leverage,
        amount: amount,
        margin: margin,
        reason: reason,
        asset: selectedAsset
    });
    saveHistory();
    balance += exit * amount; // –¥–æ–±–∞–≤–ª—è–µ–º –≤—Å—é —Å—É–º–º—É –ø—Ä–æ–¥–∞–∂–∏
    position = null; stopLoss = null; takeProfit = null;
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
    syncGlobals();
    let msg = `–ü–æ–∑–∏—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∞ (${reason})! –†–µ–∑—É–ª—å—Ç–∞—Ç: ${formatPrice(pnl)} $ (–ü–ª–µ—á–æ ${leverage}x, ${amount} BTC, –º–∞—Ä–∂–∞: ${formatPrice(margin)} $). –ë–∞–ª–∞–Ω—Å: ${balance.toFixed(4)} $`;
    let msgClass = pnl >= 0 ? 'success' : 'error';
    updateUI(msg, msgClass);
    if (reason === '—Ç–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç') {
        setTimeout(botAutoBuy, 200);
    }
    saveAllUserData();
}

function checkPosition() {
    if(!position) return;
    if(position.type === 'long') {
        if(stopLoss !== null && price <= stopLoss) {
            const profit = stopLoss - position.entry;
            closePosition(profit, '—Å—Ç–æ–ø-–ª–æ—Å—Å');
        } else if(takeProfit !== null && price >= takeProfit) {
            const profit = takeProfit - position.entry;
            closePosition(profit, '—Ç–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç');
        }
    } else if(position.type === 'short') {
        if(stopLoss !== null && price >= stopLoss) {
            const profit = position.entry - stopLoss;
            closePosition(profit, '—Å—Ç–æ–ø-–ª–æ—Å—Å');
        } else if(takeProfit !== null && price <= takeProfit) {
            const profit = position.entry - takeProfit;
            closePosition(profit, '—Ç–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç');
        }
    }
}

function showHistory() {
    const modal = document.getElementById('historyModal');
    const content = document.getElementById('historyContent');
    if(history.length === 0) {
        content.innerHTML = '<em>–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</em>';
    } else {
        content.innerHTML = `<table style='width:100%; border-collapse:collapse;'>
            <tr><th style='border-bottom:1px solid #ccc;'>–¢–∏–ø</th><th style='border-bottom:1px solid #ccc;'>–í—Ö–æ–¥ (${selectedAsset}, $)</th><th style='border-bottom:1px solid #ccc;'>–í—ã—Ö–æ–¥ (${selectedAsset}, $)</th><th style='border-bottom:1px solid #ccc;'>–ö–æ–ª-–≤–æ ${selectedAsset}</th><th style='border-bottom:1px solid #ccc;'>–ú–∞—Ä–∂–∞ ($)</th><th style='border-bottom:1px solid #ccc;'>–°—É–º–º–∞ –ø—Ä–æ–¥–∞–∂–∏ ($)</th><th style='border-bottom:1px solid #ccc;'>P/L</th><th style='border-bottom:1px solid #ccc;'>–ü—Ä–∏—á–∏–Ω–∞</th></tr>
            ${history.map(h => `<tr>
                <td>${h.type === 'long' ? 'Long' : 'Short'}</td>
                <td>${formatPrice(h.entry, h.asset || selectedAsset)}</td>
                <td>${h.exit !== null ? formatPrice(h.exit, h.asset || selectedAsset) : '-'}</td>
                <td>${Number(h.amount).toFixed(4)}</td>
                <td>${Number(h.margin).toFixed(4)}</td>
                <td>${(h.exit !== null && h.amount) ? (Number(h.exit) * Number(h.amount)).toFixed(4) : '-'}</td>
                <td style='color:${h.profit !== null && h.profit >= 0 ? 'green' : (h.profit !== null ? 'red' : 'black')};'>${h.profit !== null ? Number(h.profit).toFixed(4) : '-'}</td>
                <td>${h.reason}</td>
            </tr>`).join('')}
        </table>`;
    }
    modal.style.display = 'block';
}

function closeHistory() {
    document.getElementById('historyModal').style.display = 'none';
}

function clearHistory() {
    history = [];
    saveHistory();
    showHistory();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–π —Ü–µ–Ω—ã –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∞–∫—Ç–∏–≤–∞ —á–µ—Ä–µ–∑ Binance API
async function fetchXRPPrice() {
    try {
        let symbol = 'BTCUSDT';
        const response = await fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${symbol}`);
        const data = await response.json();
        if (data && data.price) {
            price = Number(data.price);
            price = Number(price.toFixed(2));
            updateUI();
        }
    } catch (e) {
        // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    }
}
// –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω—ã –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
setInterval(fetchXRPPrice, 1000);

// === –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è Firebase ===
function showAuthMsg(msg, color = 'red') {
  document.getElementById('authMsg').textContent = msg;
  document.getElementById('authMsg').style.color = color;
}
function loginUser() {
  const email = document.getElementById('authEmail').value;
  const password = document.getElementById('authPassword').value;
  showAuthMsg('');
  auth.signInWithEmailAndPassword(email, password)
    .then(() => {
      showAuthMsg('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!', 'green');
    })
    .catch(e => {
      showAuthMsg(e.message);
    });
}
function registerUser() {
  const email = document.getElementById('authEmail').value;
  const password = document.getElementById('authPassword').value;
  const username = document.getElementById('authUsername').value;
  showAuthMsg('');
  auth.createUserWithEmailAndPassword(email, password)
    .then((userCredential) => {
      showAuthMsg('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –í–æ–π–¥–∏—Ç–µ.', 'green');
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º username –≤ Firestore
      const uid = userCredential.user.uid;
      db.collection('users').doc(uid).set({
        displayName: username,
        email: email,
        balance: 10000,
        history: [],
        position: null,
        stopLoss: null,
        takeProfit: null
      }, { merge: true });
    })
    .catch(e => {
      showAuthMsg(e.message);
    });
}
function logoutUser() {
  auth.signOut();
}
function sendPasswordReset() {
  const email = document.getElementById('authEmail').value;
  if (!email) {
    showAuthMsg('–í–≤–µ–¥–∏—Ç–µ email –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è!');
    return;
  }
  auth.sendPasswordResetEmail(email)
    .then(() => {
      showAuthMsg('–ü–∏—Å—å–º–æ –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!', 'green');
    })
    .catch(e => {
      showAuthMsg(e.message);
    });
}
// –°–ª–µ–¥–∏–º –∑–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
auth.onAuthStateChanged(user => {
  if (user) {
    document.getElementById('authSection').style.display = 'none';
    document.getElementById('simSection').style.display = '';
    document.getElementById('logoutBtn').style.display = '';
    loadUserData(user.uid);
  } else {
    document.getElementById('authSection').style.display = '';
    document.getElementById('simSection').style.display = 'none';
    document.getElementById('logoutBtn').style.display = 'none';
  }
});

// === –†–∞–±–æ—Ç–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –≤ Firestore ===
async function loadUserData(uid) {
  const doc = await db.collection('users').doc(uid).get();
  if (doc.exists) {
    const data = doc.data();
    console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ Firestore:', data); // –û–¢–õ–ê–î–ö–ê
    balance = typeof data.balance === 'number' ? data.balance : 10000;
    history = Array.isArray(data.history) ? data.history : [];
    position = data.position || null;
    stopLoss = data.stopLoss !== undefined ? data.stopLoss : null;
    takeProfit = data.takeProfit !== undefined ? data.takeProfit : null;
  } else {
    // –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî —Å–æ–∑–¥–∞—ë–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    balance = 10000;
    history = [];
    position = null;
    stopLoss = null;
    takeProfit = null;
    await saveUserData(uid);
  }
  updateUI();
}
async function saveUserData(uid) {
  const dataToSave = {
    balance,
    history,
    position,
    stopLoss,
    takeProfit
  };
  console.log('–°–æ—Ö—Ä–∞–Ω—è—é –≤ Firestore:', dataToSave); // –û–¢–õ–ê–î–ö–ê
  await db.collection('users').doc(uid).set(dataToSave);
}
// –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞, –ø–æ–∑–∏—Ü–∏–∏, —Å—Ç–æ–ø–æ–≤ –∏ —Ç.–¥.
function saveAllUserData() {
  const user = auth.currentUser;
  if (user) saveUserData(user.uid);
}

function removeTake() {
    takeProfit = null;
    syncGlobals();
    updateUI('–¢–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç —É–¥–∞–ª—ë–Ω', 'success');
    saveAllUserData();
}
function removeStop() {
    stopLoss = null;
    syncGlobals();
    updateUI('–°—Ç–æ–ø-–ª–æ—Å—Å —É–¥–∞–ª—ë–Ω', 'success');
    saveAllUserData();
}
</script>
</body>
</html> 